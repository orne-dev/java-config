<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConfigProviderConfigurer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Orne Config</a> &gt; <a href="index.source.html" class="el_package">dev.orne.config.spring</a> &gt; <span class="el_source">ConfigProviderConfigurer.java</span></div><h1>ConfigProviderConfigurer.java</h1><pre class="source lang-java linenums">package dev.orne.config.spring;

/*-
 * #%L
 * Orne Config
 * %%
 * Copyright (C) 2019 - 2025 Orne Developments
 * %%
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Lesser Public License for more details.
 * 
 * You should have received a copy of the GNU General Lesser Public
 * License along with this program.  If not, see
 * &lt;http://www.gnu.org/licenses/lgpl-3.0.html&gt;.
 * #L%
 */

import java.util.Map;

import javax.validation.constraints.NotNull;

import org.apiguardian.api.API;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeansException;
import org.springframework.beans.factory.BeanFactoryUtils;
import org.springframework.beans.factory.BeanInitializationException;
import org.springframework.beans.factory.ListableBeanFactory;
import org.springframework.beans.factory.config.BeanFactoryPostProcessor;
import org.springframework.beans.factory.config.BeanPostProcessor;
import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;
import org.springframework.context.EnvironmentAware;
import org.springframework.core.env.Environment;

import dev.orne.config.Config;
import dev.orne.config.ConfigProvider;
import dev.orne.config.impl.ConfigProviderImpl;

/**
 * Bean factory post processor that provides a {@code ConfigProvider}
 * customized per Spring context configuration.
 * 
 * @author &lt;a href=&quot;https://github.com/ihernaez&quot;&gt;(w) Iker Hernaez&lt;/a&gt;
 * @version 1.0, 2025-11
 * @since 1.0
 */
@API(status = API.Status.INTERNAL, since = &quot;1.0&quot;)
public class ConfigProviderConfigurer
implements EnvironmentAware, BeanFactoryPostProcessor, BeanPostProcessor {

    /** The class logger. */
<span class="fc" id="L59">    private static final Logger LOG = LoggerFactory.getLogger(ConfigProviderConfigurer.class);</span>

    /** The name of the automatic {@code Config} bean. */
    public static final String AUTO_CONFIG = &quot;orneConfigAutomaticConfig&quot;;
    /** The name of the automatic {@code ConfigProvider} bean. */
    public static final String AUTO_CONFIG_PROVIDER = &quot;orneConfigAutomaticConfigProvider&quot;;

    /** The Spring environment. */
    protected Environment environment;
    /** The bean factory. */
    protected ListableBeanFactory beanFactory;
    /** The application provided configuration provider bean name. */
    protected String appConfigProviderBeanName;
    /** The application provided configuration provider customizer bean name. */
    protected String customizerBeanName;
    /** The configuration provider. */
    protected ConfigProvider configProvider;
    /** The created configuration provider. */
    protected ConfigProviderImpl ownConfigProvider;

    /**
     * Creates a new instance.
     */
    public ConfigProviderConfigurer() {
<span class="fc" id="L83">        super();</span>
<span class="fc" id="L84">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void setEnvironment(
            final Environment environment) {
<span class="fc" id="L92">        this.environment = environment;</span>
<span class="fc" id="L93">    }</span>

    /**
     * Detects application provided {@code ConfigProvider} and
     * {@code ConfigProviderCustomizer} beans.
     * 
     * {@inheritDoc}
     */
    @Override
    public void postProcessBeanFactory(
            final @NotNull ConfigurableListableBeanFactory beanFactory)
    throws BeansException {
<span class="fc" id="L105">        this.beanFactory = beanFactory;</span>
<span class="fc" id="L106">        final String[] providerNames = beanFactory.getBeanNamesForType(ConfigProvider.class);</span>
<span class="fc" id="L107">        final String[] customizerNames = beanFactory.getBeanNamesForType(ConfigProviderCustomizer.class);</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">        if (providerNames.length &gt; 1) {</span>
<span class="nc" id="L109">            throw new BeanInitializationException(providerNames.length + &quot; implementations of &quot; +</span>
                    &quot;ConfigProvider were found when only 1 is supported. &quot; +
                    &quot;Refactor the configuration such that ConfigProvider is &quot; +
                    &quot;implemented only once or not at all.&quot;);
        }
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">        if (customizerNames.length &gt; 1) {</span>
<span class="nc" id="L115">            throw new BeanInitializationException(customizerNames.length + &quot; implementations of &quot; +</span>
                    &quot;ConfigProviderCustomizer were found when only 1 is supported. &quot; +
                    &quot;Refactor the configuration such that ConfigProvider is &quot; +
                    &quot;implemented only once or not at all.&quot;);
        }
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        if (providerNames.length == 1) {</span>
<span class="nc" id="L121">            this.appConfigProviderBeanName = providerNames[0];</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">            if (customizerNames.length == 1) {</span>
<span class="nc" id="L123">                LOG.warn(&quot;A ConfigProviderCustomizer was found ({}) but will be ignored &quot; +</span>
                        &quot;because a ConfigProvider implementation is also provided ({}).&quot;,
                        customizerNames[0],
                        this.appConfigProviderBeanName);
            }
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        } else if (customizerNames.length == 1) {</span>
<span class="nc" id="L129">            this.customizerBeanName = customizerNames[0];</span>
        }
<span class="fc" id="L131">    }</span>

    /**
     * Registers 
     */
    @Override
    public @NotNull Object postProcessAfterInitialization(
            final @NotNull Object bean,
            final @NotNull String beanName)
    throws BeansException {
<span class="pc bpc" id="L141" title="3 of 4 branches missed.">        if (bean instanceof Config &amp;&amp; this.ownConfigProvider != null) {</span>
<span class="nc" id="L142">            LOG.debug(&quot;Registering Config bean '{}' initialized after ConfigProvider creation...&quot;, beanName);</span>
<span class="nc" id="L143">            this.ownConfigProvider.registerConfig((Config) bean);</span>
        }
<span class="fc" id="L145">        return bean;</span>
    }

    /**
     * Creates and exposes the automatically created {@code Config} bean,
     * if any.
     * 
     * @return The automatically created {@code ConfigProvider} bean.
     */
    public synchronized @NotNull ConfigProvider getConfigProvider() {
<span class="fc bfc" id="L155" title="All 2 branches covered.">        if (this.configProvider == null) {</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">            if (this.appConfigProviderBeanName == null) {</span>
<span class="fc" id="L157">                LOG.debug(&quot;Creating default ConfigProvider bean...&quot;);</span>
<span class="fc" id="L158">                this.ownConfigProvider = createConfigProvider();</span>
<span class="fc" id="L159">                this.configProvider = this.ownConfigProvider;</span>
            } else {
<span class="nc" id="L161">                LOG.debug(&quot;Using application provided ConfigProvider: {}&quot;,</span>
                        this.appConfigProviderBeanName);
<span class="nc" id="L163">                this.configProvider = this.beanFactory.getBean(</span>
                        this.appConfigProviderBeanName,
                        ConfigProvider.class);
            }
        }
<span class="fc" id="L168">        return this.configProvider;</span>
    }

    /**
     * Creates a new configuration provider.
     * 
     * @return The new configuration provider.
     */
    protected @NotNull ConfigProviderImpl createConfigProvider() {
<span class="fc" id="L177">        final Map&lt;String, Config&gt; configs = BeanFactoryUtils.beansOfTypeIncludingAncestors(</span>
                beanFactory,
                Config.class);
        final ConfigProviderImpl provider;
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        if (this.customizerBeanName == null) {</span>
<span class="fc" id="L182">            provider = new ConfigProviderImpl(createDefaultConfig());</span>
<span class="fc" id="L183">            configs.values().stream().forEach(provider::registerConfig);</span>
        } else {
<span class="nc" id="L185">            LOG.debug(&quot;Using application provided ConfigProvider customizer: {}&quot;,</span>
                    this.customizerBeanName);
<span class="nc" id="L187">            final ConfigProviderCustomizer customizer = beanFactory.getBean(</span>
                    this.customizerBeanName,
                    ConfigProviderCustomizer.class);
<span class="nc" id="L190">            provider = new ConfigProviderImpl(</span>
<span class="nc" id="L191">                    customizer.configureDefaultConfig(configs));</span>
<span class="nc" id="L192">            customizer.registerAdditionalConfigs(provider::registerConfig, configs);</span>
        }
<span class="fc" id="L194">        return provider;</span>
    }

    /**
     * Creates a Spring based default configuration.
     * 
     * @return The default configuration.
     */
    protected @NotNull Config createDefaultConfig() {
<span class="fc" id="L203">        LOG.info(&quot;Creating default Spring Environment based Config...&quot;);</span>
<span class="fc" id="L204">        return Config.fromSpringEnvironment()</span>
<span class="fc" id="L205">                .ofEnvironment(this.environment)</span>
<span class="fc" id="L206">                .withIterableKeys()</span>
<span class="fc" id="L207">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>